name: CI
on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - name: Validate repository structure
        run: |
          echo "=== Repository structure validation ==="
          test -f README.md && echo "pass: README.md exists" || { echo "FAIL: README.md missing"; exit 1; }
          echo "--- Checking documentation files ---"
          MD_COUNT=0
          while IFS= read -r -d "" f; do
            MD_COUNT=$((MD_COUNT + 1))
            SIZE=$(wc -c < "$f")
            WORDS=$(wc -w < "$f")
            echo "  $f: ${SIZE} bytes, ${WORDS} words"
          done < <(find . -name "*.md" -not -path "./.github/*" -print0)
          echo "pass: Found ${MD_COUNT} markdown files"
          test "$MD_COUNT" -ge 1 || { echo "FAIL: No markdown files found"; exit 1; }
          echo "=== Repository validation complete ==="
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Install project + test dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -e ".[dev]"
      - name: Lint (Ruff)
        run: ruff check src tests scripts
      - name: Compile source
        run: python -m compileall -q src
      - name: Check Alexandria-Babel scaffold artifacts
        run: python scripts/alexandria_babel_alignment.py --mode check-scaffold
      - name: Verify certainty artifacts are current
        run: python scripts/repo_certainty_audit.py --check
      - name: Run AB-PLAN-01 contract tests
        run: pytest -q tests/test_ab_plan_01.py
      - name: Run full test suite
        run: pytest -q
